<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>spacedolphin's Unreality3D Experience</title>
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no">

    <!-- Unreality3D Favicon Implementation -->
    <link rel="icon" type="image/x-icon" href="https://unreality3d.com/favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://unreality3d.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://unreality3d.com/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://unreality3d.com/images/unreality3d-logo.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://unreality3d.com/images/unreality3d-logo.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://unreality3d.com/images/unreality3d-logo.png">
    <meta name="theme-color" content="#232323">

    <!-- Google Analytics 4 (GA4) Tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N4BFSLTHZF"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'G-N4BFSLTHZF', {
            enhanced_measurements: true,
            file_downloads: true
        });
    </script>

    <style>
        html, body {
            padding: 0;
            margin: 0;
            background: #232323;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #unity-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #232323;
        }

        #unity-canvas {
            background: #232323;
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: default;
        }

        #unity-loading-bar {
            position: absolute;
            inset-block-start: 50%;
            inset-inline-start: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            inline-size: min(300px, 90vw);
            block-size: 150px;
            z-index: 1000;
            container-type: inline-size;
        }

        #unity-logo {
            inline-size: 154px;
            block-size: 130px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            color: #06b6d4;
            font-size: 24px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #unity-logo::after {
            content: "Unreality3D";
        }

        #unity-progress-bar-empty {
            inline-size: 141px;
            block-size: 18px;
            margin-block: 10px;
            background: transparent;
            border: 2px solid #ffffff;
            background-size: contain;
            position: relative;
            border-radius: 2px;
            overflow: hidden;
        }

        #unity-progress-bar-full {
            inline-size: 0%;
            block-size: 100%;
            background: light-dark(#ffffff, #60a5fa);
            position: absolute;
            inset: 0 auto 0 0;
            border-radius: inherit;
            transition: inline-size 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @container (max-width: 200px) {
            #unity-logo {
                inline-size: 100px;
                block-size: 85px;
            }
            #unity-progress-bar-empty {
                inline-size: 120px;
            }
        }

        @media (orientation: landscape) {
            #unity-canvas { width: 100vw; height: 100vh; }
        }

        @media (orientation: portrait) {
            #unity-canvas { width: 100vw; height: 100vh; }
        }

        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        /* ============================================ */
        /* WebXR/VR Button Styles                       */
        /* ============================================ */
        
        #webxr-button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
            display: none; /* Hidden by default, shown when VR is supported */
        }

        #enter-vr-button {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            border-radius: 12px;
            color: white;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            font-family: Arial, sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
        }

        #enter-vr-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        #enter-vr-button:active {
            transform: translateY(0);
        }

        #enter-vr-button:disabled {
            background: #4b5563;
            cursor: not-allowed;
            box-shadow: none;
        }

        #enter-vr-button svg {
            width: 24px;
            height: 24px;
        }

        #vr-status-message {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-family: Arial, sans-serif;
            z-index: 2000;
            display: none;
            max-width: 280px;
        }

        /* VR button pulse animation when VR is available */
        @keyframes vr-pulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(99, 102, 241, 0.7); }
        }

        #enter-vr-button.vr-available {
            animation: vr-pulse 2s ease-in-out infinite;
        }

        /* Hide VR button during immersive session */
        body.xr-session-active #webxr-button-container {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="unity-container">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>

    <!-- WebXR/VR Enter Button -->
    <div id="webxr-button-container">
        <button id="enter-vr-button" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 8a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-4l-2 2h-4l-2-2H4a2 2 0 0 1-2-2V8z"/>
                <circle cx="8" cy="12" r="2"/>
                <circle cx="16" cy="12" r="2"/>
            </svg>
            <span>Enter VR</span>
        </button>
    </div>
    <div id="vr-status-message"></div>

    <script>
        // UPDATED: Environment Detection with path-based URL support
        function detectEnvironment() {
            const hostname = window.location.hostname.toLowerCase();
            const pathname = window.location.pathname;

            // NEW: Path-based URL detection for unreality3d.com/creator/project/
            if (hostname === 'unreality3d.com') {
                const pathParts = pathname.split('/').filter(p => p.length > 0);
                
                if (pathParts.length >= 2) {
                    const creatorUsername = pathParts[0];
                    const projectName = pathParts[1];
                    
                    console.log('Path-based Professional URL detected:', `${creatorUsername}/${projectName}`);
                    
                    gtag('event', 'creator_project_visit', {
                        creator_name: creatorUsername,
                        project_name: projectName,
                        content_type: 'unity_webgl',
                        platform_section: 'creator_content',
                        url_format: 'path_based'
                    });
                    
                    return {
                        type: 'professional',
                        isProduction: true,
                        projectId: 'unreality3d',
                        creatorUsername: creatorUsername,
                        projectName: projectName,
                        urlFormat: 'path_based'
                    };
                }
            }

            // EXISTING: Subdomain URL detection (for backward compatibility)
            if (hostname.endsWith('.unreality3d.com') && hostname !== 'unreality3d.com') {
                const creatorUsername = hostname.replace('.unreality3d.com', '');
                const projectName = pathname.split('/').filter(p => p.length > 0)[0] || 'main';
                
                console.log('Subdomain Professional URL detected:', hostname);
                
                gtag('event', 'creator_project_visit', {
                    creator_name: creatorUsername,
                    project_name: projectName,
                    content_type: 'unity_webgl',
                    platform_section: 'creator_content',
                    url_format: 'subdomain'
                });
                
                return {
                    type: 'professional',
                    isProduction: true,
                    projectId: 'unreality3d',
                    creatorUsername: creatorUsername,
                    projectName: projectName,
                    urlFormat: 'subdomain'
                };
            }

            if (hostname.includes('unreality3d.web.app') || hostname.includes('unreality3d.firebaseapp.com')) {
                gtag('event', 'platform_visit', {
                    content_type: 'platform_hosting',
                    platform_section: 'firebase_hosting'
                });
                return { type: 'firebase', isProduction: true, projectId: 'unreality3d' };
            }

            if (hostname.includes('unreality3d2025.web.app') || hostname.includes('unreality3d2025.firebaseapp.com')) {
                gtag('event', 'platform_visit', {
                    content_type: 'platform_hosting',
                    platform_section: 'firebase_development'
                });
                return { type: 'firebase', isProduction: false, projectId: 'unreality3d2025' };
            }

            if (hostname.includes('github.io')) {
                gtag('event', 'platform_visit', {
                    content_type: 'github_pages',
                    platform_section: 'direct_github'
                });
                return { type: 'github-pages', isProduction: true, projectId: 'unreality3d' };
            }

            gtag('event', 'platform_visit', {
                content_type: 'unknown_hosting',
                platform_section: 'fallback'
            });
            return { type: 'creator', isProduction: true, projectId: 'unreality3d' };
        }

        const environment = detectEnvironment();
        environment.creatorPayPalEmail = 'laurie@unreality3d.com';
        let unityInstance = null;

        // ============================================
        // WebXR/VR Session Management
        // ============================================
        
        let xrSession = null;
        let isVRSupported = false;
        
        // Check WebXR VR support
        async function checkVRSupport() {
            const vrButton = document.getElementById('enter-vr-button');
            const vrContainer = document.getElementById('webxr-button-container');
            const vrStatus = document.getElementById('vr-status-message');
            
            if (!navigator.xr) {
                console.log('ü•Ω WebXR not available in this browser');
                showVRStatus('WebXR not supported in this browser');
                
                gtag('event', 'webxr_check', {
                    supported: false,
                    reason: 'no_navigator_xr',
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
                return;
            }
            
            try {
                isVRSupported = await navigator.xr.isSessionSupported('immersive-vr');
                
                if (isVRSupported) {
                    console.log('ü•Ω WebXR VR supported!');
                    vrContainer.style.display = 'block';
                    vrButton.disabled = false;
                    vrButton.classList.add('vr-available');
                    vrButton.querySelector('span').textContent = 'Enter VR';
                    
                    gtag('event', 'webxr_check', {
                        supported: true,
                        session_type: 'immersive-vr',
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main'
                    });
                } else {
                    console.log('ü•Ω WebXR VR not supported on this device');
                    showVRStatus('VR not supported on this device');
                    
                    gtag('event', 'webxr_check', {
                        supported: false,
                        reason: 'device_not_supported',
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main'
                    });
                }
            } catch (error) {
                console.error('ü•Ω Error checking VR support:', error);
                showVRStatus('Error checking VR support');
                
                gtag('event', 'webxr_error', {
                    error_type: 'support_check_failed',
                    error_message: error.message,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            }
        }
        
        function showVRStatus(message, duration = 5000) {
            const vrStatus = document.getElementById('vr-status-message');
            vrStatus.textContent = message;
            vrStatus.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    vrStatus.style.display = 'none';
                }, duration);
            }
        }
        
        // Toggle VR session - uses Unity WebXR Export's API
        function toggleVRSession() {
            const vrButton = document.getElementById('enter-vr-button');

            if (!unityInstance) {
                console.error('ü•Ω Unity not loaded yet');
                showVRStatus('Unity not loaded yet');
                return;
            }

            try {
                vrButton.disabled = true;
                vrButton.querySelector('span').textContent = 'Starting VR...';

                console.log('ü•Ω Calling Unity WebXR toggleVR...');

                gtag('event', 'webxr_session_request', {
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });

                // Call Unity WebXR Export's toggleVR function
                // This is exposed by the WebXR Export package
                if (unityInstance.Module && unityInstance.Module.WebXR && unityInstance.Module.WebXR.toggleVR) {
                    unityInstance.Module.WebXR.toggleVR();
                    console.log('ü•Ω WebXR toggleVR called');
                } else {
                    console.error('ü•Ω WebXR Export API not found on Unity instance');
                    console.log('ü•Ω Available on Module:', Object.keys(unityInstance.Module || {}));
                    showVRStatus('WebXR not available in Unity build');
                    vrButton.disabled = false;
                    vrButton.querySelector('span').textContent = 'Enter VR';
                    return;
                }

                // The WebXR Export package handles session state
                // We just need to update our button state based on callbacks
                // For now, assume it worked - Unity will handle the actual session

                vrButton.disabled = false;
                vrButton.querySelector('span').textContent = 'Exit VR';
                document.body.classList.add('xr-session-active');

                gtag('event', 'webxr_session_start', {
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });

            } catch (error) {
                console.error('ü•Ω Failed to toggle VR session:', error);
                vrButton.disabled = false;
                vrButton.querySelector('span').textContent = 'Enter VR';
                showVRStatus('Failed to start VR: ' + error.message);

                gtag('event', 'webxr_session_error', {
                    error_type: error.name,
                    error_message: error.message,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            }
        }

        // Listen for Unity WebXR state changes to update button
        document.addEventListener('onVRSupportedCheck', function(event) {
            console.log('ü•Ω Unity VR support check:', event.detail);
            const vrButton = document.getElementById('enter-vr-button');
            const vrContainer = document.getElementById('webxr-button-container');

            if (event.detail && event.detail.supported) {
                isVRSupported = true;
                vrContainer.style.display = 'block';
                vrButton.disabled = false;
                vrButton.classList.add('vr-available');
            }
        });

        document.addEventListener('onXRSessionStarted', function(event) {
            console.log('ü•Ω Unity XR session started');
            xrSession = true; // Track state (not actual session object)
            document.body.classList.add('xr-session-active');

            const vrButton = document.getElementById('enter-vr-button');
            vrButton.querySelector('span').textContent = 'Exit VR';
            vrButton.classList.remove('vr-available');
            vrButton.disabled = false;

            gtag('event', 'webxr_session_start', {
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main'
            });
        });

        document.addEventListener('onXRSessionEnded', function(event) {
            console.log('ü•Ω Unity XR session ended');
            xrSession = null;
            document.body.classList.remove('xr-session-active');

            const vrButton = document.getElementById('enter-vr-button');
            vrButton.querySelector('span').textContent = 'Enter VR';
            vrButton.classList.add('vr-available');
            vrButton.disabled = false;

            gtag('event', 'webxr_session_end', {
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main'
            });
        });

        // Initialize VR button
        document.getElementById('enter-vr-button').addEventListener('click', toggleVRSession);

        // ============================================
        // PayPal Integration (unchanged)
        // ============================================

        console.log('üí≥ PayPal integration will be loaded from platform domain');
        
        // Check for PayPal bridge availability
        function checkPayPalBridgeReady() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 60; // Increased to 30 seconds
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    
                    // Check multiple indicators that PayPal bridge is ready
                    if (window.paypalPlatformBridgeReady || 
                        window.paypalSDKReady || 
                        (typeof window.StartDirectPayPalDualTransaction === 'function' && 
                         window.StartDirectPayPalDualTransaction !== arguments.callee)) {
                        clearInterval(checkInterval);
                        console.log('‚úÖ PayPal bridge ready');
                        resolve(true);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        console.warn('‚ö†Ô∏è PayPal bridge not loaded after 30 seconds');
                        resolve(false);
                    } else if (attempts % 10 === 0) {
                        console.log(`‚è≥ Waiting for PayPal bridge... (${ attempts * 0.5 }s)`);
                    }
                }, 500);
            });
        }

        // Send results back to Unity
        function sendUnityPaymentResult(success, transactionDetails = null) {
            if (!unityInstance) {
                console.warn('‚ö†Ô∏è Unity instance not available');
                return;
            }

            const gameObjectName = window.currentPayPalGameObject;
            
            if (!gameObjectName) {
                console.error('‚ùå No GameObject name stored');
                return;
            }

            try {
                unityInstance.SendMessage(gameObjectName, 'OnPaymentComplete', success);
                
                if (success === 'true' && transactionDetails) {
                    unityInstance.SendMessage(gameObjectName, 'OnTransactionDetails', JSON.stringify(transactionDetails));
                }
                
                console.log('‚úÖ Payment result sent to Unity');
                
            } catch (error) {
                console.error('‚ùå Failed to send message to Unity:', error);
            }
        }

        // Placeholder functions - will be overridden by PayPal bridge
        window.StartDirectPayPalDualTransaction = function(paymentData) {
            console.log('üí≥ PayPal transaction requested - checking bridge availability...');
            
            checkPayPalBridgeReady().then((ready) => {
                if (ready) {
                    // Try to call the actual function if it was overridden
                    if (typeof window.StartDirectPayPalDualTransaction === 'function' && 
                        window.StartDirectPayPalDualTransaction !== arguments.callee) {
                        console.log('‚úÖ PayPal bridge loaded, calling actual function');
                        window.StartDirectPayPalDualTransaction(paymentData);
                    } else if (window.paypalSDKReady && typeof paypal !== 'undefined') {
                        console.log('‚úÖ PayPal SDK available directly');
                        // Use direct PayPal if available
                        if (typeof window.initializePayPalCheckout === 'function') {
                            window.currentPaymentData = paymentData;
                            window.initializePayPalCheckout();
                        } else {
                            console.error('‚ùå PayPal functions not available');
                            sendUnityPaymentResult('false');
                        }
                    } else {
                        console.error('‚ùå PayPal bridge ready but functions not available');
                        sendUnityPaymentResult('false');
                    }
                } else {
                    console.error('‚ùå PayPal bridge not available after waiting');
                    console.error('‚ùå Check that Load Balancer is injecting PayPal script');
                    sendUnityPaymentResult('false');
                }
            }).catch((error) => {
                console.error('‚ùå Error checking PayPal bridge:', error);
                sendUnityPaymentResult('false');
            });
        };

        window.TestDirectPayPalConnection = function(gameObjectName) {
            console.log('üß™ PayPal connection test requested - checking bridge...');
            
            checkPayPalBridgeReady().then((ready) => {
                if (ready) {
                    if (typeof window.TestDirectPayPalConnection === 'function' && 
                        window.TestDirectPayPalConnection !== arguments.callee) {
                        console.log('‚úÖ Calling actual PayPal test function');
                        window.TestDirectPayPalConnection(gameObjectName);
                    } else {
                        console.log('‚úÖ PayPal bridge ready, sending success');
                        if (unityInstance) {
                            unityInstance.SendMessage(gameObjectName, 'OnConnectionTestComplete', 'true');
                        }
                    }
                } else {
                    console.error('‚ùå PayPal bridge not available for testing');
                    if (unityInstance) {
                        unityInstance.SendMessage(gameObjectName, 'OnConnectionTestComplete', 'false');
                    }
                }
            }).catch((error) => {
                console.error('‚ùå Error in PayPal connection test:', error);
                if (unityInstance) {
                    unityInstance.SendMessage(gameObjectName, 'OnConnectionTestComplete', 'false');
                }
            });
        };

        // ============================================
        // Unity WebGL Loading
        // ============================================
        
        function loadUnity() {
            gtag('event', 'unity_load_start', {
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main',
                content_type: 'unity_webgl'
            });

            var container = document.querySelector("#unity-container");
            var canvas = document.querySelector("#unity-canvas");
            var loadingBar = document.querySelector("#unity-loading-bar");
            var progressBarFull = document.querySelector("#unity-progress-bar-full");
            var warningBanner = document.querySelector("#unity-warning");

            // Ensure loading bar is visible during loading
            loadingBar.style.display = "flex";  // Show loading bar initially
            canvas.style.display = "none";      // Hide canvas until loaded

            function unityShowBanner(msg, type) {
                console.log('Unity Banner:', msg, type);
        
                if (type === 'error') {
                    gtag('event', 'unity_load_error', {
                        error_message: msg,
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main'
                    });
                }
        
                function updateBannerVisibility() {
                    warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
                }
                var div = document.createElement('div');
                div.innerHTML = msg;
                warningBanner.appendChild(div);
                if (type == 'error') div.style = 'background: red; padding: 5px;';
                else {
                    if (type == 'warning') div.style = 'background: yellow; color: black; padding: 5px;';
                    setTimeout(function() {
                        warningBanner.removeChild(div);
                        updateBannerVisibility();
                    }, 5000);
                }
                updateBannerVisibility();
            }

            var buildUrl = "Build";
            var loaderUrl = buildUrl + "/1763a1aa9cc9332b14a2fa1f5be2c873.loader.js?v=1770068244714";
            var config = {
                dataUrl: buildUrl + "/58e0a7ae48f8534bd4c7fc1f374ac60f.data?v=1770068244714",
                frameworkUrl: buildUrl + "/b8d7602dbcbb553c76e4d04f1ba8fc0c.framework.js?v=1770068244714",
                codeUrl: buildUrl + "/c6c3f6cb49a112bd6fecc2b6d436e1c5.wasm?v=1770068244714",
                streamingAssetsUrl: "StreamingAssets",
                companyName: "spacedolphin",
                productName: "spacedolphin's Unreality3D Experience",
                productVersion: "1.0.0",
                showBanner: unityShowBanner,
                cacheControl: function (url) {
                    if (!url || typeof url !== 'string') {
                        console.warn('Unity cacheControl called with invalid URL:', url);
                        return "no-store";
                    }
                    if (url.match(/\.data/) || url.match(/\.wasm/) || url.match(/\.framework\.js/)) {
                        return "must-revalidate";
                    }
                    return "no-store";
                }
            };

            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
                config.devicePixelRatio = 1;
                unityShowBanner('WebGL builds are not supported on mobile devices.');
        
                gtag('event', 'mobile_access_attempt', {
                    device_type: 'mobile',
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            } else {
                canvas.style.width = "100vw";
                canvas.style.height = "100vh";
            }

            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    // Update progress bar during loading
                    progressBarFull.style.width = 100 * progress + "%";
                    console.log('üîÑ Unity loading progress: ' + Math.round(progress * 100) + '%');
            
                    if (progress === 0.5) {
                        gtag('event', 'unity_load_50_percent', {
                            creator_name: environment.creatorUsername || 'platform',
                            project_name: environment.projectName || 'main'
                        });
                    }
                }).then((instance) => {
                    unityInstance = instance;
            
                    // Only hide loading bar AFTER Unity loads completely
                    loadingBar.style.display = "none";
                    canvas.style.display = "block";  // Show canvas when ready
            
                    console.log('üéÆ Unity loaded - PayPal bridge integration ready');
                    
                    // Check VR support after Unity loads
                    checkVRSupport();
            
                    gtag('event', 'unity_load_complete', {
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main',
                        load_time_ms: Date.now() - performance.timing.navigationStart
                    });
            
                }).catch((message) => {
                    // Hide loading bar on error too
                    loadingBar.style.display = "none";
                    canvas.style.display = "block";
            
                    gtag('event', 'unity_load_failed', {
                        error_message: message,
                        creator_name: environment.creatorUsername || 'platform',
                        project_name: environment.projectName || 'main'
                    });
                    alert(message);
                });
            };
    
            script.onerror = () => {
                // Handle script load failure
                loadingBar.style.display = "none";
                canvas.style.display = "block";
        
                gtag('event', 'unity_script_load_failed', {
                    script_url: loaderUrl,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            };
    
            document.body.appendChild(script);
        }

        // Responsive canvas handling
        function handleResize() {
            if (unityInstance) {
                const canvas = document.querySelector("#unity-canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                gtag('event', 'unity_canvas_resize', {
                    new_width: window.innerWidth,
                    new_height: window.innerHeight,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            }
        }

        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', handleResize);

        // Prevent default touch behaviors on canvas
        document.addEventListener('touchstart', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchend', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', function(e) {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        }, { passive: false });

        // Debug helper
        window.debugPayPalGameObject = function() {
            const gameObjectName = window.currentPayPalGameObject;
            console.log('üîç Debug: Current PayPal GameObject name:', gameObjectName || 'NOT SET');
            
            if (!gameObjectName) {
                console.warn('‚ö†Ô∏è No GameObject name stored!');
                console.warn('‚ö†Ô∏è Make sure Unity calls UnityStartDirectPayPalTransaction');
            } else {
                console.log('‚úÖ GameObject name is properly stored for SendMessage calls');
            }
            
            return gameObjectName;
        };
        
        // Debug helper for WebXR
        window.debugWebXRStatus = function() {
            console.log('ü•Ω WebXR Debug Info:');
            console.log('   - navigator.xr available:', !!navigator.xr);
            console.log('   - VR supported:', isVRSupported);
            console.log('   - Active session:', !!xrSession);
            console.log('   - Unity instance:', !!unityInstance);
            return { 
                xrAvailable: !!navigator.xr, 
                vrSupported: isVRSupported, 
                activeSession: !!xrSession,
                unityLoaded: !!unityInstance
            };
        };

        // Page engagement tracking
        let pageStartTime = Date.now();
        let engagementTracked = false;
        
        setTimeout(() => {
            if (!engagementTracked) {
                gtag('event', 'page_engagement_30s', {
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main',
                    engagement_time_msec: 30000
                });
                engagementTracked = true;
            }
        }, 30000);
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                gtag('event', 'page_hidden', {
                    time_on_page: Date.now() - pageStartTime,
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
            } else {
                gtag('event', 'page_visible', {
                    creator_name: environment.creatorUsername || 'platform',
                    project_name: environment.projectName || 'main'
                });
                pageStartTime = Date.now();
            }
        });

        window.addEventListener('beforeunload', function() {
            gtag('event', 'page_exit', {
                total_time_on_page: Date.now() - pageStartTime,
                creator_name: environment.creatorUsername || 'platform',
                project_name: environment.projectName || 'main'
            });
        });

        // Load Unity immediately
        loadUnity();

        console.log('üéÆ Unity WebGL Template loaded');
        console.log('üéØ Revenue split: 95% Creator, 5% Platform');
        console.log('üí≥ PayPal processing: Platform domain injection');
        console.log('üåê Professional URL support enabled');
        console.log('üìä GA4 Analytics tracking enabled');
        console.log('ü•Ω WebXR/VR support enabled');
        
        gtag('event', 'template_initialized', {
            template_version: 'platform_domain_paypal_webxr_v2025',
            creator_name: environment.creatorUsername || 'platform',
            project_name: environment.projectName || 'main',
            features: ['platform_domain_paypal', 'dual_transactions', 'pwa', 'ga4_tracking', 'load_balancer_injection', 'webxr_vr']
        });
    </script>
</body>
</html>